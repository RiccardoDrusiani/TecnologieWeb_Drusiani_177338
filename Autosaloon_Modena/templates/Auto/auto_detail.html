{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-5" style="width:100%;">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-12 col-xxl-11" style="max-width: 1200px; padding-left: 150px; padding-right: 150px; width: 100%;">
            {# ALERT STATO AUTO #}
            {% if auto.disponibilita == 3 %}
                <div class="alert alert-danger text-center" role="alert">Auto attualmente in contrattazione</div>
            {% elif auto.disponibilita == 1 %}
                <div class="alert alert-danger text-center" role="alert">Auto attualmente affittata</div>
            {% elif auto.disponibilita == 6 %}
                <div class="alert alert-danger text-center" role="alert">Auto attualmente prenotata</div>
            {% endif %}
            <div class="card shadow-lg border-0 rounded-4" style="margin-top: 20px; margin-bottom: 20px; width: 150%; margin-left: -25%;">
                <div class="row g-0">
                    {% if auto.immagine %}
                    <div class="col-md-5 d-flex align-items-center justify-content-center p-3">
                        <img src="{{ auto.immagine.url }}" class="img-fluid rounded-4 w-100" alt="{{ auto.marca }} {{ auto.modello }}">
                    </div>
                    {% endif %}
                    <div class="col-md-7 p-4">
                        <h2 class="fw-bold mb-3">{{ auto.marca }} {{ auto.modello }}</h2>
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item"><strong>Anno:</strong> {{ auto.anno }}</li>
                            <li class="list-group-item"><strong>Cilindrata:</strong> {{ auto.cilindrata }} cc</li>
                            <li class="list-group-item"><strong>Carburante:</strong> {{ auto.get_carburante_display }}</li>
                            <li class="list-group-item"><strong>Cambio:</strong> {{ auto.get_cambio_display }}</li>
                            <li class="list-group-item"><strong>Trazione:</strong> {{ auto.get_trazione_display }}</li>
                            <li class="list-group-item"><strong>Chilometraggio:</strong> {{ auto.chilometraggio|default:'N/A' }} km</li>
                            <li class="list-group-item"><strong>Disponibilit√†:</strong> {{ auto.get_disponibilita_display }}</li>
                        </ul>
                        {% if auto.descrizione %}
                        <div class="mb-3">
                            <strong>Descrizione:</strong>
                            <p>{{ auto.descrizione }}</p>
                        </div>
                        {% endif %}
                        {# BOTTONI AZIONE #}
                        <div class="mb-3">
                            <form method="post" action="">
                                {% csrf_token %}
                                <button type="button" class="btn btn-success me-2" {% if auto.disponibilita == 1 or auto.disponibilita == 3 or auto.disponibilita == 6 %}disabled{% endif %}>Compra</button>
                                <button type="button" class="btn btn-primary me-2" {% if auto.disponibilita == 1 or auto.disponibilita == 3 or auto.disponibilita == 6 %}disabled{% endif %}>Affitta</button>
                                <button type="button" class="btn btn-warning me-2" {% if auto.disponibilita == 1 or auto.disponibilita == 3 or auto.disponibilita == 6 %}disabled{% endif %}>Prenota</button>
                                <button type="button" class="btn btn-info me-2" {% if auto.disponibilita == 1 or auto.disponibilita == 3 or auto.disponibilita == 6 %}disabled{% endif %}>Contratta</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {# SEZIONE COMMENTI #}
            <div class="card mt-4" style ="width: 100%;">
                <div class="card-header"><strong>Commenti</strong></div>
                <div class="card-body" style="width: 100%;">
                    {% if is_utente and not auto.user_auto == user %}
                        <form method="post" action="{% url 'Utente:crea_commento' %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <textarea name="testo" class="form-control" rows="2" placeholder="Scrivi un commento..."></textarea>
                            </div>
                            <input type="hidden" name="auto_id" value="{{ auto.pk }}">
                            <button type="submit" class="btn btn-outline-primary">Invia commento</button>
                        </form>
                        <hr>
                    {% endif %}
                    {% for commento in auto.commenti.all %}
                        <div class="mb-3 border-bottom pb-2">
                            <div><strong>{{ commento.user.username }}</strong> <span class="text-muted small">{{ commento.data_creazione|date:'d/m/Y H:i' }}</span></div>
                            <div>{{ commento.testo }}</div>
                            <div class="mt-2">
                                {% if user.is_authenticated and auto.user_auto == user %}
                                    <a href="#" class="btn btn-sm btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#rispostaModal{{ commento.id }}" onclick="event.stopPropagation();">Rispondi</a>
                                {% endif %}
                                {% if user.is_authenticated and not commento.user.concessionaria_profile %}
                                    <a href="{% url 'Utente:crea_segnalazione' %}?commento_id={{ commento.id }}" class="btn btn-sm btn-outline-danger">Segnala</a>
                                {% endif %}
                            </div>
                            {% for risposta in commento.risposte.all %}
                                <div class="ms-4 mt-2 border-start ps-2">
                                    <div><strong>{{ risposta.user.username }}</strong> <span class="text-muted small">{{ risposta.data_creazione|date:'d/m/Y H:i' }}</span></div>
                                    <div>{{ risposta.testo }}</div>
                                </div>
                            {% endfor %}
                            {% if user.is_authenticated and auto.user_auto == user %}
                            <div class="ms-4 mt-2">
                                <form class="ajax-risposta-form" data-commento-id="{{ commento.id }}" method="post" action="{% url 'Utente:crea_risposta' %}?commento_id={{ commento.id }}" autocomplete="off">
                                    {% csrf_token %}
                                    <div class="input-group mb-2">
                                        <textarea name="testo" class="form-control" rows="2" placeholder="Scrivi una risposta..." required style="resize: none;"></textarea>
                                        <button type="submit" class="btn btn-success ms-2">Rispondi</button>
                                    </div>
                                </form>
                            </div>
                            <script>
                              document.addEventListener('DOMContentLoaded', function() {
                                var form = document.querySelector('.ajax-risposta-form[data-commento-id="{{ commento.id }}"]');
                                if(form) {
                                  form.addEventListener('submit', function(e) {
                                    e.preventDefault();
                                    var formData = new FormData(form);
                                    fetch(form.action, {
                                      method: 'POST',
                                      headers: {
                                        'X-Requested-With': 'XMLHttpRequest',
                                      },
                                      body: formData
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                      if(data.success) {
                                        var risposteContainer = form.parentNode.parentNode;
                                        var rispostaHtml = `<div class=\"ms-4 mt-2 border-start ps-2\"><div><strong>${data.username}</strong> <span class=\"text-muted small\">${data.data_creazione}</span></div><div>${data.testo}</div></div>`;
                                        risposteContainer.insertAdjacentHTML('beforeend', rispostaHtml);
                                        form.reset();
                                      } else {
                                        alert('Errore: ' + (data.error || 'Impossibile salvare la risposta.'));
                                      }
                                    })
                                    .catch(() => alert('Errore di rete.'));
                                  });
                                }
                              });
                            </script>
                            {% endif %}
                        </div>
                    {% empty %}
                        <div class="text-muted">Nessun commento presente.</div>
                    {% endfor %}
                </div>
            </div>
            {# BOTTONE STICKY #}
            <a href="{% url 'Auto:user_autos' %}" class="btn btn-secondary position-fixed" style="bottom: 30px; right: 30px; z-index: 9999;">Torna alla schermata dei veicoli</a>
        </div>
    </div>
</div>
{% endblock %}
