{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-5" style="width:100%;">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-12 col-xxl-11" style="max-width: 1200px; padding-left: 150px; padding-right: 150px; width: 100%;">
            {# ALERT STATO AUTO #}

            {% if auto.disponibilita == 3 %}
                <div class="alert alert-danger text-center" role="alert">Auto attualmente in contrattazione</div>
            {% elif auto.disponibilita == 4 %}
                <div class="alert alert-danger text-center" role="alert">Auto attualmente in contrattazione</div>
            {% elif auto.disponibilita == 5 %}
                <div class="alert alert-danger text-center" role="alert">Auto attualmente in contrattazione</div>
            {% elif auto.disponibilita == 6 %}
                <div class="alert alert-danger text-center" role="alert">Auto attualmente prenotata</div>
            {% elif auto.disponibilita == 7 %}
                <div class="alert alert-danger text-center" role="alert">Auto attualmente in affitto</div>
            {% endif %}
            <div class="card shadow-lg border-0 rounded-4" style="margin-top: 20px; margin-bottom: 20px; width: 150%; margin-left: -25%;">
                <div class="row g-0">
                    {% if auto.immagine %}
                    <div class="col-md-5 d-flex align-items-center justify-content-center p-3">
                        <img src="{{ auto.immagine.url }}" class="img-fluid rounded-4 w-100" alt="{{ auto.marca }} {{ auto.modello }}">
                    </div>
                    {% endif %}
                    <div class="col-md-7 p-4">
                        <h2 class="fw-bold mb-3">{{ auto.marca }} {{ auto.modello }}</h2>
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item"><strong>Anno:</strong> {{ auto.anno }}</li>
                            <li class="list-group-item"><strong>Cilindrata:</strong> {{ auto.cilindrata }} cc</li>
                            <li class="list-group-item"><strong>Carburante:</strong> {{ auto.get_carburante_display }}</li>
                            <li class="list-group-item"><strong>Cambio:</strong> {{ auto.get_cambio_display }}</li>
                            <li class="list-group-item"><strong>Trazione:</strong> {{ auto.get_trazione_display }}</li>
                            <li class="list-group-item"><strong>Chilometraggio:</strong> {{ auto.chilometraggio|default:'N/A' }} km</li>
                            <li class="list-group-item"><strong>Disponibilit√†:</strong> {{ auto.get_disponibilita_display }}</li>
                        </ul>
                        {% if auto.descrizione %}
                        <div class="mb-3">
                            <strong>Descrizione:</strong>
                            <p>{{ auto.descrizione }}</p>
                        </div>
                        {% endif %}
                        {# BOTTONI AZIONE #}
                        <div class="mb-3">
                            <form method="post" action="">
                                {% csrf_token %}
                                {% if user.is_authenticated %}
                                    {% if is_in_disponibilita %}
                                        {% if user.id != auto.user_auto.id %}
                                            <a href="{% url 'Auto:acquisto_auto' auto.pk %}" class="btn btn-success me-2 {% if auto.disponibilita == 1 or auto.disponibilita == 3 or auto.disponibilita == 6 %}disabled{% endif %}" role="button" aria-disabled="{% if auto.disponibilita == 1 or auto.disponibilita == 3 or auto.disponibilita == 6 %}true{% else %}false{% endif %}">Compra</a>
                                            {% if is_utente %}
                                                <a href="#" data-bs-toggle="modal" data-bs-target="#affittoModal" class="btn btn-primary me-2 {% if auto.disponibilita == 1 or auto.disponibilita == 3 or auto.disponibilita == 6 %}disabled{% endif %}" role="button" aria-disabled="{% if auto.disponibilita == 1 or auto.disponibilita == 3 or auto.disponibilita == 6 %}true{% else %}false{% endif %}">Affitta</a>
                                                <a href="{% url 'Auto:prenota_auto' auto.pk %}" class="btn btn-warning me-2 {% if auto.disponibilita == 1 or auto.disponibilita == 3 or auto.disponibilita == 6 %}disabled{% endif %}" role="button" aria-disabled="{% if auto.disponibilita == 1 or auto.disponibilita == 3 or auto.disponibilita == 6 %}true{% else %}false{% endif %}">Prenota</a>
                                            {% endif %}
                                            <a href="{% url 'Auto:contrattazione_auto' auto.pk %}" class="btn btn-info me-2 {% if auto.disponibilita == 1 or auto.disponibilita == 3 or auto.disponibilita == 6 %}disabled{% endif %}" role="button" aria-disabled="{% if auto.disponibilita == 1 or auto.disponibilita == 3 or auto.disponibilita == 6 %}true{% else %}false{% endif %}">Contratta</a>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {# SEZIONE COMMENTI #}
            <div class="card mt-4" style ="width: 100%;">
                <div class="card-header"><strong>Commenti</strong></div>
                <div class="card-body" style="width: 100%;">
                    {% if is_utente and not auto.user_auto == user %}
                        <form method="post" action="{% url 'Utente:crea_commento' %}">
                            {% csrf_token %}
                            <div class="mb-3">
                                <textarea name="testo" class="form-control" rows="2" placeholder="Scrivi un commento..."></textarea>
                            </div>
                            <input type="hidden" name="auto_id" value="{{ auto.pk }}">
                            <button type="submit" class="btn btn-outline-primary">Invia commento</button>
                        </form>
                        <hr>
                    {% endif %}
                    {% for commento in auto.commenti.all %}
                        <div class="mb-3 border-bottom pb-2">
                            <div><strong>{{ commento.user.username }}</strong> <span class="text-muted small">{{ commento.data_creazione|date:'d/m/Y H:i' }}</span></div>
                            <div>{{ commento.testo }}</div>
                            <div class="mt-2">
                                {% if user.is_authenticated and auto.user_auto == user %}
                                    <a href="#" class="btn btn-sm btn-outline-secondary me-2" onclick="event.stopPropagation();">Rispondi</a>
                                {% endif %}
                                {% if user.is_authenticated and not commento.user.concessionaria_profile %}
                                    <a href="{% url 'Utente:crea_segnalazione' %}?commento_id={{ commento.id }}" class="btn btn-sm btn-outline-danger">Segnala</a>
                                {% endif %}
                            </div>
                            {% for risposta in commento.risposte.all %}
                                <div class="ms-4 mt-2 border-start ps-2">
                                    <div><strong>{{ risposta.user.username }}</strong> <span class="text-muted small">{{ risposta.data_creazione|date:'d/m/Y H:i' }}</span></div>
                                    <div>{{ risposta.testo }}</div>
                                </div>
                            {% endfor %}
                            {% if user.is_authenticated and auto.user_auto == user %}
                            <div class="ms-4 mt-2">
                                <form class="ajax-risposta-form" data-commento-id="{{ commento.id }}" method="post" action="{% url 'Utente:crea_risposta' %}?commento_id={{ commento.id }}" autocomplete="off">
                                    {% csrf_token %}
                                    <div class="input-group mb-2">
                                        <textarea name="testo" class="form-control" rows="2" placeholder="Scrivi una risposta..." required style="resize: none;"></textarea>
                                        <button type="submit" class="btn btn-success ms-2">Rispondi</button>
                                    </div>
                                </form>
                            </div>
                            <script>
                              document.addEventListener('DOMContentLoaded', function() {
                                var form = document.querySelector('.ajax-risposta-form[data-commento-id="{{ commento.id }}"]');
                                if(form) {
                                  form.addEventListener('submit', function(e) {
                                    e.preventDefault();
                                    var formData = new FormData(form);
                                    fetch(form.action, {
                                      method: 'POST',
                                      headers: {
                                        'X-Requested-With': 'XMLHttpRequest',
                                      },
                                      body: formData
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                      if(data.success) {
                                        var risposteContainer = form.parentNode.parentNode;
                                        var rispostaHtml = `<div class=\"ms-4 mt-2 border-start ps-2\"><div><strong>${data.username}</strong> <span class=\"text-muted small\">${data.data_creazione}</span></div><div>${data.testo}</div></div>`;
                                        risposteContainer.insertAdjacentHTML('beforeend', rispostaHtml);
                                        form.reset();
                                      } else {
                                        alert('Errore: ' + (data.error || 'Impossibile salvare la risposta.'));
                                      }
                                    })
                                    .catch(() => alert('Errore di rete.'));
                                  });
                                }
                              });
                            </script>
                            {% endif %}
                        </div>
                    {% empty %}
                        <div class="text-muted">Nessun commento presente.</div>
                    {% endfor %}
                </div>
            </div>
            {# BOTTONE STICKY #}
            {% if user.is_authenticated %}
                <a href="{% url 'Auto:user_autos' %}" class="btn btn-secondary position-fixed" style="bottom: 30px; right: 30px; z-index: 9999;">Torna alla schermata dei veicoli</a>
            {% endif %}
            {# BOTTONE TORNA ALLA HOME #}
            <a href="{% url 'Autosalone:home' %}" class="btn btn-secondary position-fixed" style="bottom: 30px; right: 300px; z-index: 9999;">Torna alla schermata iniziale</a>
        </div>
    </div>
</div>

<!-- Modal Affitto -->
<div class="modal fade" id="affittoModal" tabindex="-1" aria-labelledby="affittoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'Auto:affitta_auto' auto.pk %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="affittoModalLabel">Affitta l'auto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="data_inizio" class="form-label">Data inizio</label>
            <input type="date" class="form-control" id="data_inizio" name="data_inizio" required>
          </div>
          <div class="mb-3">
            <label for="data_fine" class="form-label">Data fine</label>
            <input type="date" class="form-control" id="data_fine" name="data_fine" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Totale:</label>
            <span id="totaleAffitto">0</span> ‚Ç¨
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="submit" class="btn btn-primary">Conferma Affitto</button>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
  // Prezzo giornaliero passato dal backend, esempio:
  const prezzoGiornaliero = {{ auto.affitto.first.prezzo_affitto|default:50 }};
  const totaleSpan = document.getElementById('totaleAffitto');
  function calcolaTotale() {
    const inizio = document.getElementById('data_inizio').value;
    const fine = document.getElementById('data_fine').value;
    if (inizio && fine) {
      const start = new Date(inizio);
      const end = new Date(fine);
      const diff = (end - start) / (1000 * 60 * 60 * 24) + 1;
      if (diff > 0) {
        totaleSpan.textContent = diff * prezzoGiornaliero;
      } else {
        totaleSpan.textContent = 0;
      }
    } else {
      totaleSpan.textContent = 0;
    }
  }
  document.getElementById('data_inizio').addEventListener('change', calcolaTotale);
  document.getElementById('data_fine').addEventListener('change', calcolaTotale);
</script>
<style>
.popup-segnalazione-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
}
.popup-segnalazione-overlay.attivo {
    display: flex !important;
}
.popup-segnalazione-box {
    background: #fff;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    min-width: 300px;
    max-width: 90vw;
}
</style>
<script>
function apriPopupSegnalazione(id) {
    var el = document.getElementById('popup-segnalazione-' + id);
    if(el) {
        el.classList.add('attivo');
        el.onclick = function(e) {
            if(e.target === el) chiudiPopupSegnalazione(id);
        };
    }
}
function chiudiPopupSegnalazione(id) {
    var el = document.getElementById('popup-segnalazione-' + id);
    if(el) {
        el.classList.remove('attivo');
        el.onclick = null;
    }
}
function confermaSegnalazione(id) {
    window.location.href = '/Utente/segnalazione/crea/?commento_id=' + id;
}
</script>
{% endblock %}
